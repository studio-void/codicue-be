<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Chat Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .input-group {
        margin-bottom: 10px;
      }
      label {
        display: inline-block;
        width: 100px;
        font-weight: bold;
      }
      input,
      button {
        padding: 8px;
        margin: 5px;
      }
      input[type='text'],
      input[type='number'] {
        width: 200px;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      #messages {
        height: 300px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        background-color: #f9f9f9;
        font-family: monospace;
        white-space: pre-wrap;
      }
      .status {
        font-weight: bold;
        margin-bottom: 10px;
      }
      .connected {
        color: green;
      }
      .disconnected {
        color: red;
      }
      .error {
        color: red;
      }
      .info {
        color: blue;
      }
    </style>
  </head>
  <body>
    <h1>WebSocket Chat Test</h1>

    <div class="container">
      <h3>연결 설정</h3>
      <div class="input-group">
        <label>서버 URL:</label>
        <input
          type="text"
          id="serverUrl"
          value="https://codicue-be.vercel.app/chat"
        />
      </div>
      <div class="input-group">
        <label>JWT 토큰:</label>
        <input
          type="text"
          id="jwtToken"
          placeholder="Bearer 토큰을 입력하세요"
        />
      </div>
      <button id="connectBtn">연결</button>
      <button id="disconnectBtn" disabled>연결 해제</button>
      <div class="status" id="connectionStatus">연결되지 않음</div>
    </div>

    <div class="container">
      <h3>채팅 기능</h3>
      <div class="input-group">
        <label>채팅방 ID:</label>
        <input type="number" id="chatId" placeholder="채팅방 ID" />
        <button id="joinChatBtn" disabled>채팅방 입장</button>
        <button id="leaveChatBtn" disabled>채팅방 나가기</button>
      </div>
      <div class="input-group">
        <label>메시지:</label>
        <input
          type="text"
          id="messageInput"
          placeholder="메시지를 입력하세요"
        />
        <button id="sendMessageBtn" disabled>메시지 전송</button>
      </div>
    </div>

    <div class="container">
      <h3>메시지 로그</h3>
      <button onclick="clearMessages()">로그 지우기</button>
      <div id="messages"></div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      let socket = null;
      const messages = document.getElementById('messages');
      const connectionStatus = document.getElementById('connectionStatus');

      function addMessage(type, message) {
        const timestamp = new Date().toLocaleTimeString();
        const messageElement = document.createElement('div');
        messageElement.className = type;
        messageElement.textContent = `[${timestamp}] ${message}`;
        messages.appendChild(messageElement);
        messages.scrollTop = messages.scrollHeight;
      }

      function clearMessages() {
        messages.innerHTML = '';
      }

      function updateConnectionStatus(status, className) {
        connectionStatus.textContent = status;
        connectionStatus.className = `status ${className}`;
      }

      function updateButtonStates(connected) {
        document.getElementById('connectBtn').disabled = connected;
        document.getElementById('disconnectBtn').disabled = !connected;
        document.getElementById('joinChatBtn').disabled = !connected;
        document.getElementById('leaveChatBtn').disabled = !connected;
        document.getElementById('sendMessageBtn').disabled = !connected;
      }

      // 연결 버튼
      document.getElementById('connectBtn').addEventListener('click', () => {
        const serverUrl = document.getElementById('serverUrl').value;
        const jwtToken = document.getElementById('jwtToken').value;

        if (!jwtToken) {
          alert('JWT 토큰을 입력해주세요.');
          return;
        }

        try {
          socket = io(serverUrl, {
            auth: {
              token: jwtToken,
            },
          });

          socket.on('connect', () => {
            addMessage('connected', '서버에 연결되었습니다.');
            updateConnectionStatus('연결됨', 'connected');
            updateButtonStates(true);
          });

          socket.on('disconnect', () => {
            addMessage('disconnected', '서버와 연결이 끊어졌습니다.');
            updateConnectionStatus('연결 끊어짐', 'disconnected');
            updateButtonStates(false);
          });

          socket.on('connected', (data) => {
            addMessage('info', `환영 메시지: ${JSON.stringify(data)}`);
          });

          socket.on('joinedChat', (data) => {
            addMessage('info', `채팅방 입장: ${JSON.stringify(data)}`);
          });

          socket.on('leftChat', (data) => {
            addMessage('info', `채팅방 나감: ${JSON.stringify(data)}`);
          });

          socket.on('newMessage', (data) => {
            addMessage('info', `새 메시지: ${JSON.stringify(data)}`);
          });

          socket.on('systemMessage', (data) => {
            addMessage('info', `시스템 메시지: ${JSON.stringify(data)}`);
          });

          socket.on('notification', (data) => {
            addMessage('info', `알림: ${JSON.stringify(data)}`);
          });

          socket.on('error', (data) => {
            addMessage('error', `에러: ${JSON.stringify(data)}`);
          });

          socket.on('connect_error', (error) => {
            addMessage('error', `연결 에러: ${error.message}`);
            updateConnectionStatus('연결 실패', 'error');
          });
        } catch (error) {
          addMessage('error', `연결 실패: ${error.message}`);
        }
      });

      // 연결 해제 버튼
      document.getElementById('disconnectBtn').addEventListener('click', () => {
        if (socket) {
          socket.disconnect();
          socket = null;
        }
      });

      // 채팅방 입장 버튼
      document.getElementById('joinChatBtn').addEventListener('click', () => {
        const chatId = parseInt(document.getElementById('chatId').value);
        if (!chatId) {
          alert('채팅방 ID를 입력해주세요.');
          return;
        }

        socket.emit('joinChat', { chatId });
        addMessage('info', `채팅방 ${chatId} 입장 요청`);
      });

      // 채팅방 나가기 버튼
      document.getElementById('leaveChatBtn').addEventListener('click', () => {
        const chatId = parseInt(document.getElementById('chatId').value);
        if (!chatId) {
          alert('채팅방 ID를 입력해주세요.');
          return;
        }

        socket.emit('leaveChat', { chatId });
        addMessage('info', `채팅방 ${chatId} 나가기 요청`);
      });

      // 메시지 전송 버튼
      document
        .getElementById('sendMessageBtn')
        .addEventListener('click', () => {
          const chatId = parseInt(document.getElementById('chatId').value);
          const content = document.getElementById('messageInput').value;

          if (!chatId) {
            alert('채팅방 ID를 입력해주세요.');
            return;
          }

          if (!content.trim()) {
            alert('메시지를 입력해주세요.');
            return;
          }

          socket.emit('sendMessage', { chatId, content });
          addMessage('info', `메시지 전송: "${content}" (채팅방 ${chatId})`);
          document.getElementById('messageInput').value = '';
        });

      // Enter 키로 메시지 전송
      document
        .getElementById('messageInput')
        .addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            document.getElementById('sendMessageBtn').click();
          }
        });

      addMessage('info', 'WebSocket 테스트 페이지가 준비되었습니다.');
    </script>
  </body>
</html>
